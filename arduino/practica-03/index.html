<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Contenido del taller impartido para Euroavia Sevilla de C y Arduino sobre LOLIN-WeMos D1 Mini - ESP8266">
    <meta name="author" content="CieNTi">
    
    <link rel="../../img/favicon.ico">

    
    <title>Práctica 3 - Uso de librerías - Taller de C y Arduino</title>
    

    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">
    <link href="../../css/highlight.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.6.28/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <a class="navbar-brand" href="../..">Taller de C y Arduino</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Introducción <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../introduccion/">Introducción</a>
</li>

                        
                            
<li >
    <a href="../../introduccion/carpeta-de-trabajo/">Carpeta de trabajo</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../../lenguaje-c/">C</a>
                    </li>
                
                
                
                    <li >
                        <a href="../../hardware/">Hardware</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Arduino <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../">Introducción a Arduino</a>
</li>

                        
                            
<li >
    <a href="../practica-01/">Práctica 1</a>
</li>

                        
                            
<li >
    <a href="../practica-02/">Práctica 2 - El bus I2C</a>
</li>

                        
                            
<li class="active">
    <a href="./">Práctica 3 - Uso de librerías</a>
</li>

                        
                            
<li >
    <a href="../practica-04/">Práctica 4</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Otros recursos <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../otros-recursos/">Otros recursos</a>
</li>

                        
                            
<li >
    <a href="../../otros-recursos/mqtt-broker/">MQTT Broker</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../practica-02/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../practica-04/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/euroavia-sevilla/curso-c-arduino/edit/master/workshop/arduino/practica-03/README.md"><i class="fab fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#practica-3-uso-de-librerias">Práctica 3 - Uso de librerías</a></li>
            <li class="second-level"><a href="#introduccion">Introducción</a></li>
                
            <li class="second-level"><a href="#como-continuar">Como continuar</a></li>
                
            <li class="second-level"><a href="#practica">Práctica</a></li>
                
                <li class="third-level"><a href="#bme280-temperatura-humedad-presion-altitud">BME280: Temperatura, Humedad, Presión, Altitud</a></li>
                <li class="third-level"><a href="#mpu6050-temperatura-aceleracion-rotacion">MPU6050: Temperatura, Aceleración, Rotación</a></li>
                <li class="third-level"><a href="#spiffs-ficheros-en-memoria-interna">SPIFFS: Ficheros en memoria interna</a></li>
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="practica-3-uso-de-librerias">Práctica 3 - Uso de librerías</h1>
<p>Tras aprender lo que es el bus I2C y como acceder a los datos en bruto de un dispositivo, en esta práctica se usará una libreria para que haga ese mismo trabajo.</p>
<p>Esto supone una primera ventaja clara: en lugar de necesitar saber los pormenores de un chip, ahora solo será necesario saber cómo se usan las funciones de una librería.</p>
<h2 id="introduccion">Introducción</h2>
<p>Una libreria es uno o varios ficheros de código en donde ya hay programadas ciertas funcionalidades y se incluyen en el código en forma de paquete, lo que:</p>
<ul>
<li>Simplificará enormemente el proceso de desarrollo</li>
<li>Incrementará la calidad y legibilidad del código final</li>
<li>Necesitará de mucho menos tiempo para obtener los mismos resultados</li>
<li>Evitará errores innecesarios, pues normalmente han pasado muchas pruebas</li>
<li>Si una libreria falla suele haber alternativas</li>
</ul>
<p>Aunque no se haya estudiado en profundidad, esto ya se ha utilizado en los programas del taller en el momento que se usa, por ejemplo, <code>#include &lt;Wire.h&gt;</code>.</p>
<p>Lo que realmente se está haciendo es incluir la cabecera de la librería <code>Wire</code>, que dará a conocer al programa una serie de variables, funciones, clases, etc. De esta forma pasan a estar disponibles, y por lo tanto, su funcionalidad.</p>
<p>Dicho de otro modo, la librería <code>Wire</code> evita tener que leer uno o varios datasheets de un microcontrolador para saber cómo hacer funcionar el bus I2C en su forma mas basica.</p>
<blockquote>
<p>Sin la libreria <code>Wire</code> sería necesario programar funciones como <code>Wire.requestFrom()</code> o <code>Wire.read()</code>, lo que haría prácticamente inviable desarrollos a corto plazo.</p>
</blockquote>
<p>La siguiente figura muestra el modelo de capas de abstracción que se está usando:</p>
<p><img alt="abstraction-layers.png" src="abstraction-layers.png" /></p>
<p>Para el caso del sensor BME280, supondría una gran ventaja disponer de una librería que ya hiciera todo el trabajo de pedir los datos y convertirlos, con tan solo definir los parámetros básicos del bus I2C y dirección de esclavo &hellip; y es lo que se verá a continuación.</p>
<h2 id="como-continuar">Como continuar</h2>
<p>Lo primero es buscar y estudiar las posibilidades, y para esto Arduino facilita la tarea mediante un gestor de librerias, al que se accede a través de <em>Herramientas &gt; Gestor de librerias &hellip;</em>, obteniendo algo como en la siguiente figura:</p>
<p><img alt="arduino-library-manager.png" src="arduino-library-manager.png" /></p>
<p>Como se continuará con el sensor BME280, se pone como filtro de búsqueda, lo que resultará en algo como:</p>
<p><img alt="arduino-library-manager_BME280.png" src="arduino-library-manager_BME280.png" /></p>
<blockquote>
<p>Para la práctica se ha seleccionado la de <strong>SparkFun Electronics</strong>, por ser una de las mas completas, configurables y robustas. Esto no significa que no se pueda buscar información del resto, probarlas, y sacar conclusiones propias.</p>
</blockquote>
<h2 id="practica">Práctica</h2>
<p>Una vez visto el mecanismo de instalación y uso de librerías, se proporcionan los siguientes ejemplos para cada parte interesante del dispositivo, con vistas a utilizar todos o parte de los elementos para la última práctica, donde se construirá un nodo IoT WiFi completamente funcional.</p>
<p>Se recomienda compilar, probar y salvar cada ejemplo, para asi ver las particularidades de cada uno, y tomar consciencia del trabajo que pueda necesitar unificar todo en un único programa.</p>
<h3 id="bme280-temperatura-humedad-presion-altitud">BME280: Temperatura, Humedad, Presión, Altitud</h3>
<h4 id="resumen">Resumen</h4>
<table>
<thead>
<tr>
<th align="left">Libreria</th>
<th align="center">Enlaces de interés</th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>SparkFun BME280</code> de <em>SparkFun Electronics</em></td>
<td align="center"><a href="https://github.com/sparkfun/SparkFun_BME280_Arduino_Library"><i class="fa fa-link" style="color:#FA023C"></i> Repositorio</a></td>
<td align="center">Documentado con ejemplos</td>
<td align="center"><a href="https://github.com/sparkfun/SparkFun_BME280_Arduino_Library/tree/master/examples"><i class="fa fa-link" style="color:#FA023C"></i> Ejemplos</a></td>
<td align="center"><a href="https://github.com/sparkfun/SparkFun_BME280_Arduino_Library/tree/master/src"><i class="fa fa-link" style="color:#FA023C"></i> Código fuente</a></td>
</tr>
</tbody>
</table>
<h4 id="ejemplo-funcional">Ejemplo funcional</h4>
<pre><code class="C">/* Include required headers and/or libraries */
#include &lt;Wire.h&gt;
#include &quot;SparkFunBME280.h&quot;

#define SLAVE_ADDRESS 0x76

/* Instantiate a BME280 object called BME280_obj */
BME280 BME280_obj;

/*
 * Single-pass function to configure the app
 */
void setup()
{
  /* Start serial for output */
  Serial.begin(115200);

  /* Join I2C bus and set it to 400 kHz */
  Wire.begin(0, 2);
  Wire.setClock(400000);

  /* Address the sensor */
  BME280_obj.setI2CAddress(SLAVE_ADDRESS);

  /* Check communication before continue */
  if (BME280_obj.beginI2C(Wire) == false)
  {
    Serial.printf(&quot;The sensor did not respond. Please check wiring.\n&quot;);

    /* Stop here (WDT will reset at some point) */
    while(1);
  }

  /* -- Configure the sensor --
   *  - Read  the  datasheet -
   */
  /* Filter coefficient.          | 0 to 4 is valid.   | See 3.4.4     */
  BME280_obj.setFilter(2);
  /* Time between readings.       | 0 to 7 valid.      | See table 27. */
  BME280_obj.setStandbyTime(1);
  /* 0 disables temp sensing.     | 0 to 16 are valid. | See table 24. */
  BME280_obj.setTempOverSample(8);
  /* 0 disables pressure sensing. | 0 to 16 are valid. | See table 23. */
  BME280_obj.setPressureOverSample(8);
  /* 0 disables humidity sensing. | 0 to 16 are valid. | See table 19. */
  BME280_obj.setHumidityOverSample(8);
  /* MODE_SLEEP, MODE_FORCED, MODE_NORMAL is valid.    | See 3.3       */
  BME280_obj.setMode(MODE_NORMAL);
}

/*
 * Recurrent task, called forever
 */
void loop()
{
  /* Welcome message! Useful as a control point */
  Serial.printf(&quot;Ahoy! ESP8266 here!\n---\n&quot;);

  /* Read and print sensor data */
  Serial.printf(&quot; - Temp.: %2.2f [C]\n&quot;,  BME280_obj.readTempC());
  Serial.printf(&quot; - Temp.: %2.2f [F]\n&quot;,  BME280_obj.readTempF());
  Serial.printf(&quot; - Hum..: %2.2f [%%]\n&quot;, BME280_obj.readFloatHumidity());
  Serial.printf(&quot; - Pres.: %2.2f [Pa]\n&quot;, BME280_obj.readFloatPressure());
  Serial.printf(&quot; - Alt..: %2.2f [m]\n&quot;,  BME280_obj.readFloatAltitudeMeters());
  Serial.printf(&quot; - Alt..: %2.2f [Ft]\n&quot;, BME280_obj.readFloatAltitudeFeet());

  /* Ensure not to flood with a huge amount of fast data */
  delay(500);
}
</code></pre>

<h4 id="salida-esperada">Salida esperada</h4>
<pre><code class="text">Ahoy! ESP8266 here!
---
 - Temp.: 34.08 [C]
 - Temp.: 93.34 [F]
 - Hum..: 26.10 [%]
 - Pres.: 101292.66 [Pa]
 - Alt..: 2.69 [m]
 - Alt..: 8.83 [Ft]
Ahoy! ESP8266 here!
---
 - Temp.: 34.05 [C]
 - Temp.: 93.29 [F]
 - Hum..: 26.04 [%]
 - Pres.: 101292.16 [Pa]
 - Alt..: 2.73 [m]
 - Alt..: 8.97 [Ft]
</code></pre>

<h3 id="mpu6050-temperatura-aceleracion-rotacion">MPU6050: Temperatura, Aceleración, Rotación</h3>
<h4 id="resumen_1">Resumen</h4>
<table>
<thead>
<tr>
<th align="left">Libreria</th>
<th align="center">Enlaces de interés</th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>MPU6050</code> de <em>Electronic Cats</em></td>
<td align="center"><a href="https://github.com/electroniccats/mpu6050"><i class="fa fa-link" style="color:#FA023C"></i> Repositorio</a></td>
<td align="center">Documentado con ejemplos</td>
<td align="center"><a href="https://github.com/electroniccats/mpu6050/tree/master/examples"><i class="fa fa-link" style="color:#FA023C"></i> Ejemplos</a></td>
<td align="center"><a href="https://github.com/electroniccats/mpu6050/tree/master/src"><i class="fa fa-link" style="color:#FA023C"></i> Código fuente</a></td>
</tr>
</tbody>
</table>
<h4 id="ejemplo-funcional_1">Ejemplo funcional</h4>
<pre><code class="C">/* Include required headers and/or libraries */
#include &lt;Wire.h&gt;
#include &lt;I2Cdev.h&gt;
#include &lt;MPU6050.h&gt;

#define MPU6050_ADDRESS 0x68

/* Instantiate a MPU6050 object called MPU6050_obj */
MPU6050 accelgyro(MPU6050_ADDRESS);

/* Used to translate from digital to human */
struct meas_range
{
  uint16_t ranges[4];
  uint8_t current;
}
MPU6050_range[2] =
{
  { .ranges = { 250, 500, 1000, 2000 }, .current = 0 },
  { .ranges = { 2, 4, 8, 16 },          .current = 0 },
};
#define RANGE_GYRO  0
#define RANGE_ACCEL 1

/* Get a gyro or accel raw value and convert to human-readable */
float raw_to_human(struct meas_range *range, int16_t raw_val)
{
  /* Uncomment to get details about conversion */
  //printf(&quot;Converting 0x%04X\n&quot;
  //       &quot; - %s range, current %u, value %u\n&quot;
  //       &quot; - Converted value %2.2f\n&quot;,
  //       raw_val,
  //       (range == &amp;MPU6050_range[0])?&quot; Gyro&quot;:&quot;Accel&quot;,
  //       range-&gt;current, range-&gt;ranges[range-&gt;current],
  //       (((float)raw_val * range-&gt;ranges[range-&gt;current]) / 0x7FFF)
  //       );
  return (((float)raw_val * range-&gt;ranges[range-&gt;current]) / 0x7FFF);
}

/* Convert a temperature value, method differs from gyro/accel */
float temp_to_human(int16_t raw_val)
{
  return (((float)raw_val / 340) + 36.53);
}

/*
 * Single-pass function to configure the app
 */
void setup()
{
  /* Start serial for output */
  Serial.begin(115200);

  /* Join I2C bus and set it to 400 kHz */
  Wire.begin();
  Wire.setClock(400000);

  /* Initialize the sensor */
  accelgyro.initialize();

  /* Check communication before continue */
  if (accelgyro.testConnection() == false)
  {
    Serial.printf(&quot;The sensor did not respond. Please check wiring.\n&quot;);

    /* Stop here (WDT will reset at some point) */
    while(1);
  }

  /* By default, the library uses the following settings:
   * - setFullScaleGyroRange(MPU6050_GYRO_FS_250)
   * - setFullScaleAccelRange(MPU6050_ACCEL_FS_2)
   */

  /* Configure Gyroscope range, choose from:
   * - MPU6050_GYRO_FS_250 ..: +/-250 deg/sec
   * - MPU6050_GYRO_FS_500 ..: +/-500 deg/sec
   * - MPU6050_GYRO_FS_1000 .: +/-1000 deg/sec
   * - MPU6050_GYRO_FS_2000 .: +/-2000 deg/sec
   *
   * Uncomment the following two lines to set a different value
   */
  //MPU6050_range[RANGE_GYRO].current = MPU6050_GYRO_FS_2000;
  //accelgyro.setFullScaleGyroRange(MPU6050_range[RANGE_GYRO].current);

  /* Configure Accelerometer range, choose from:
   * - MPU6050_ACCEL_FS_2 ...: +/-2g
   * - MPU6050_ACCEL_FS_4 ...: +/-4g
   * - MPU6050_ACCEL_FS_8 ...: +/-8g
   * - MPU6050_ACCEL_FS_16 ..: +/-16g
   *
   * Uncomment the following two lines to set a different value
   */
  //MPU6050_range[RANGE_ACCEL].current = MPU6050_ACCEL_FS_16;
  //accelgyro.setFullScaleAccelRange(MPU6050_range[RANGE_ACCEL].current);
}

/*
 * Recurrent task, called forever
 */
void loop()
{
  /* Welcome message! Useful as a control point */
  Serial.printf(&quot;Ahoy! ESP8266 here!\n---\n&quot;);

  /* Read and print sensor data */
  Serial.printf(&quot; - Temperature ....: %2.2f [degC]\n&quot;,
                temp_to_human(accelgyro.getTemperature()));
  Serial.printf(&quot; - Rotation X .....: %2.2f [deg/sec]\n&quot;,
                raw_to_human(&amp;MPU6050_range[RANGE_GYRO],
                             accelgyro.getRotationX()));
  Serial.printf(&quot; - Rotation Y .....: %2.2f [deg/sec]\n&quot;,
                raw_to_human(&amp;MPU6050_range[RANGE_GYRO],
                             accelgyro.getRotationY()));
  Serial.printf(&quot; - Rotation Z .....: %2.2f [deg/sec]\n&quot;,
                raw_to_human(&amp;MPU6050_range[RANGE_GYRO],
                             accelgyro.getRotationZ()));
  Serial.printf(&quot; - Acceleration X .: %2.2f [g]\n&quot;,
                raw_to_human(&amp;MPU6050_range[RANGE_ACCEL],
                             accelgyro.getAccelerationX()));
  Serial.printf(&quot; - Acceleration Y .: %2.2f [g]\n&quot;,
                raw_to_human(&amp;MPU6050_range[RANGE_ACCEL],
                             accelgyro.getAccelerationY()));
  Serial.printf(&quot; - Acceleration Z .: %2.2f [g]\n&quot;,
                raw_to_human(&amp;MPU6050_range[RANGE_ACCEL],
                             accelgyro.getAccelerationZ()));

  /* Ensure not to flood with a huge amount of fast data */
  delay(500);
}
</code></pre>

<h4 id="salida-esperada_1">Salida esperada</h4>
<blockquote>
<p><strong>NOTA:</strong> Sin haberse corregido los offsets, los datos obtenidos pueden no tener sentido, pero lo importante de esta prueba es que varien con coherencia cuando se mueva la placa. La temperatura tambien subira o bajara, aunque en fracciones coherentes.</p>
<p>Si los datos no varían, el sensor no se está midiendo correctamente.</p>
</blockquote>
<pre><code class="text">Ahoy! ESP8266 here!
---
 - Temperature ....: 32.81 [degC]
 - Rotation X .....: 0.24 [deg/sec]
 - Rotation Y .....: 3.66 [deg/sec]
 - Rotation Z .....: -3.87 [deg/sec]
 - Acceleration X .: 0.08 [g]
 - Acceleration Y .: -0.19 [g]
 - Acceleration Z .: 0.83 [g]
Ahoy! ESP8266 here!
---
 - Temperature ....: 32.86 [degC]
 - Rotation X .....: 0.10 [deg/sec]
 - Rotation Y .....: 3.27 [deg/sec]
 - Rotation Z .....: -3.88 [deg/sec]
 - Acceleration X .: 0.08 [g]
 - Acceleration Y .: -0.19 [g]
 - Acceleration Z .: 0.83 [g]
</code></pre>

<h3 id="spiffs-ficheros-en-memoria-interna">SPIFFS: Ficheros en memoria interna</h3>
<h4 id="resumen_2">Resumen</h4>
<table>
<thead>
<tr>
<th align="left">Libreria</th>
<th align="center">Enlaces de interés</th>
<th align="center"></th>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>FS</code> de <em>Ivan Grokhotkov</em></td>
<td align="center"><a href="https://github.com/esp8266/Arduino/blob/2.5.0/cores/esp8266/FS.h"><i class="fa fa-link" style="color:#FA023C"></i>Repositorio (FS.h)</a></td>
<td align="center"><a href="https://arduino-esp8266.readthedocs.io/en/2.5.0/filesystem.html"><i class="fa fa-link" style="color:#FA023C"></i> Documentación</a></td>
<td align="center"><a href="https://github.com/esp8266/Arduino/blob/2.5.0/libraries/esp8266/examples/ConfigFile/ConfigFile.ino"><i class="fa fa-link" style="color:#FA023C"></i> Ejemplo</a></td>
<td align="center"><a href="https://github.com/esp8266/Arduino/blob/2.5.0/cores/esp8266/FS.c"><i class="fa fa-link" style="color:#FA023C"></i> Código fuente</a></td>
</tr>
</tbody>
</table>
<h4 id="ejemplo-funcional_2">Ejemplo funcional</h4>
<pre><code class="C">/* Include required headers and/or libraries */
#include &lt;FS.h&gt;

#define TESTFILE &quot;/test_file.txt&quot;

/*
 * Single-pass function to configure the app
 */
void setup()
{
  /* Start serial for output */
  Serial.begin(115200);

  /* Initialize the file system */
  Serial.printf(&quot;Initializing SPIFFS\n&quot;);
  if (SPIFFS.begin() == false)
  {
    Serial.printf(&quot;SPIFFS cannot be initialized\n&quot;);

    /* Stop here (WDT will reset at some point) */
    while(1) {};
  }
}

/*
 * Recurrent task, called forever
 */
void loop()
{
  /* Welcome message! Useful as a control point */
  Serial.printf(&quot;Ahoy! ESP8266 here!\n---\n&quot;);

  File test_file;
  #define MY_STR_LEN 1024
  uint8_t my_string[MY_STR_LEN];
  uint16_t my_line = 0;

  /* The file already exist? */
  if (SPIFFS.exists(TESTFILE))
  {
    Serial.printf(&quot;File '&quot; TESTFILE &quot;'' IS found'\n&quot;);
  }
  else
  {
    Serial.printf(&quot;File '&quot; TESTFILE &quot;'' NOT found'\n&quot;);
  }

  /* Mode 'a+' create if not exists:
   *  - Read from the beginning of the file
   *  - Append new data at the end
   *  * Useful for buffers ;)
   */
  test_file = SPIFFS.open(TESTFILE, &quot;a+&quot;);
  if (!test_file)
  {
    /* Oh man, this is serious */
    Serial.printf(&quot;Cannot open '&quot; TESTFILE &quot;'' for appending'\n&quot;);
  }
  else
  {
    Serial.printf(&quot;Opened '&quot; TESTFILE &quot;'\n&quot;);

    /* Opened, now put some (at the end of the file) */
    Serial.printf(&quot;Filling file '&quot; TESTFILE &quot;' with some data\n&quot;);
    test_file.printf(&quot;This is the first line\n&quot;);
    test_file.printf(&quot;This is the second line\n&quot;);
    test_file.printf(&quot;This is the third line\n&quot;);
    test_file.close();

    /* Mode 'r' create if not exists:
     *  - Read from the beginning of the file
     *  - Fails if file not exists
     *  * Useful for safe readings without data modification
     */
    test_file = SPIFFS.open(TESTFILE, &quot;r&quot;);
    Serial.printf(&quot;Reopened '&quot; TESTFILE &quot;' for reading\n&quot;);
    Serial.printf(&quot;Contents of file '&quot; TESTFILE &quot;'\n&quot;);
    my_line = 0;
    while (test_file.position() &lt; test_file.size())
    {
      test_file.readBytesUntil('\n', my_string, MY_STR_LEN);
      Serial.printf(&quot;Line %03d: %s\n&quot;, my_line++, my_string);
    }

    /* Done, free/close the file */
    test_file.close();
    Serial.printf(&quot;Closed '&quot; TESTFILE &quot;'\n&quot;);

    /* Remove the file */
    SPIFFS.remove(TESTFILE);
    Serial.printf(&quot;Removed '&quot; TESTFILE &quot;'\n&quot;);
  }

  /* Process is locked until reset is performed */
  Serial.printf(&quot;Locking now\n&quot;);
  while (true)
  {
    /* Ensure other tasks are working (avoid WDT reset) */
    yield();
  }
}
</code></pre>

<h4 id="salida-esperada_2">Salida esperada</h4>
<pre><code class="text">Initializing SPIFFS
Ahoy! ESP8266 here!
---
File '/test_file.txt'' NOT found'
Opened '/test_file.txt'
Filling file '/test_file.txt' with some data
Contents of file '/test_file.txt'
Line 000: This is the first line
Line 001: This is the second line
Line 002: This is the third line
Closed '/test_file.txt'
Removed '/test_file.txt'
Locking now
</code></pre></div>
        
        
    </div>

    <footer class="col-md-12 text-center">
        
        <hr>
        <p>
        <small>2019 - CieNTi - Euroavia Sevilla<br></small>
        
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>

        
        
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '../..';
    </script>
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>
